<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroTutor AI - Advanced Learning Interface</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
        .task-id-display {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    background-color: rgba(255, 255, 255, 0.08); /* Subtle background */
    padding: 3px 8px;
    border-radius: 6px;
    margin-left: 10px; /* Space from agent badge */
    margin-right: 10px; /* Space from timestamp */
    cursor: pointer;
    transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease;
    display: inline-block; /* Ensures proper spacing and hover effect */
    vertical-align: middle; /* Aligns nicely with other text elements */
}

.task-id-display:hover {
    color: var(--text-primary);
    background-color: rgba(102, 126, 234, 0.3); /* Primary color with alpha, from --primary-gradient */
    transform: translateY(-1px); /* Slight lift effect */
}

/* Adjusting message-info to better accommodate the new element */
.message .message-header .message-info { /* Assuming .message-info is child of .message-header */
    display: flex;
    align-items: center;
    flex-wrap: wrap; /* Allow wrapping if space is tight */
    gap: 8px; /* Add gap between items */
}

.message .message-header .message-info strong {
    margin-right: 0; /* Remove default margin if any, rely on gap */
}

.message .message-header .message-info span:last-child { /* Timestamp */
    margin-left: auto; /* Pushes timestamp to the right if there's space */
    padding-left: 8px; /* Ensure some space if it's not pushed all the way */
}

/* If the timestamp is not the last child due to task_id, target it more specifically or adjust order */
/* Let's ensure timestamp is consistently styled if task_id is present */
.message .message-header .message-info > span { /* Targeting the timestamp span more generally */
    color: var(--text-tertiary); /* Re-apply color if needed */
    font-size: 0.8rem; /* Re-apply font-size if needed */
}
 /* Header buttons container */
.header-buttons {
    display: flex;
    gap: 12px;
    margin-right: 20px;
}

/* Base header button styles */
.header-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border: none;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

/* Button hover effects */
.header-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

/* Button active state */
.header-btn:active {
    transform: translateY(0);
    transition: transform 0.1s;
}

/* Button icon styles */
.btn-icon {
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Button label styles */
.btn-label {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* All buttons use analytics color scheme on hover */
.header-btn:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.3));
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
}

/* Responsive design for smaller screens */
@media (max-width: 768px) {
    .header-buttons {
        gap: 8px;
        margin-right: 10px;
    }
    
    .header-btn {
        padding: 8px 10px;
        font-size: 12px;
    }
    
    .btn-icon {
        font-size: 14px;
    }
    
    .btn-label {
        display: none;
    }
}

@media (max-width: 480px) {
    .header-buttons {
        gap: 6px;
        margin-right: 5px;
    }
    
    .header-btn {
        padding: 6px 8px;
        border-radius: 8px;
    }
    
    .btn-icon {
        font-size: 16px;
    }
}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            --secondary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --accent-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-tertiary: rgba(255, 255, 255, 0.6);
            --shadow-light: 0 8px 32px rgba(31, 38, 135, 0.37);
            --shadow-heavy: 0 16px 64px rgba(0, 0, 0, 0.5);
            --blur-amount: 20px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-gradient);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Animated Background */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
        }

        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(1px);
            animation: float 20s infinite linear;
        }

        .shape:nth-child(1) { 
            width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.3) 0%, transparent 70%);
            top: 10%; left: 10%;
            animation-delay: 0s;
        }
        .shape:nth-child(2) { 
            width: 150px; height: 150px;
            background: radial-gradient(circle, rgba(250, 112, 154, 0.25) 0%, transparent 70%);
            top: 60%; right: 20%;
            animation-delay: -7s;
        }
        .shape:nth-child(3) { 
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(75, 172, 254, 0.2) 0%, transparent 70%);
            bottom: 20%; left: 30%;
            animation-delay: -14s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-30px) rotate(120deg); }
            66% { transform: translateY(20px) rotate(240deg); }
        }

        /* Main Container */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            backdrop-filter: blur(10px);
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            border-bottom: 1px solid var(--glass-border);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0.1;
            z-index: -1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--primary-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(-45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(-45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(-45deg); }
            100% { transform: translateX(-100%) translateY(-100%) rotate(-45deg); }
        }

        .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2px;
        }

        .logo-text p {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .neural-activity {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .activity-dots {
            display: flex;
            gap: 4px;
        }

        .activity-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse-activity 2s infinite;
        }

        .activity-dot:nth-child(2) { animation-delay: 0.3s; }
        .activity-dot:nth-child(3) { animation-delay: 0.6s; }

        @keyframes pulse-activity {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .activity-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--secondary-gradient);
            opacity: 0.05;
            z-index: -1;
        }

        .sidebar-section {
            padding: 25px;
            border-bottom: 1px solid var(--glass-border);
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Chat History Styles */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px; /* Adjust as needed */
            overflow-y: auto;
        }

        .history-item {
            padding: 12px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            color: var(--text-secondary);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .history-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: -1;
        }

        .history-item:hover::before {
            opacity: 0.1;
        }

        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
            border-color: rgba(102, 126, 234, 0.5);
            color: var(--text-primary);
        }

        .history-item.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-light);
            font-weight: 500;
        }

        .history-item.active::before {
            opacity: 0;
        }
        .new-chat-btn {
            width: 100%;
            padding: 18px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 16px;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .new-chat-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.5s ease;
        }

        .new-chat-btn:hover::before {
            left: 100%;
        }

        .new-chat-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }

        /* Agent Cards */
        .agents-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .agent-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .agent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: -1;
        }

        .agent-card:hover::before {
            opacity: 0.1;
        }

        .agent-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-heavy);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .agent-card.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-light);
        }

        .agent-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .agent-card.active .agent-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .agent-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .agent-specialty {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 30px;
            animation: messageSlideIn 0.6s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-wrapper {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .user-avatar {
            background: var(--primary-gradient);
            color: white;
        }

        .assistant-avatar {
            background: var(--secondary-gradient);
            color: white;
        }

        .message-content {
            flex: 1;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            position: relative;
            box-shadow: var(--shadow-light);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .user-message .message-content {
            background: var(--primary-gradient);
            color: white;
            margin-left: 60px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            color: white
        }

        .agent-badge {
            padding: 6px 12px;
            background: var(--accent-gradient);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-left: auto;
        }



        /* Input Area */
        .input-area {
            padding: 25px 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            border-top: 1px solid var(--glass-border);
            position: relative;
        }

        .input-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0.05;
            z-index: -1;
        }

        .input-wrapper {
            display: flex;
            gap: 15px;
            align-items: flex-end; /* Align items to bottom for textarea growth */
            max-width: 1200px; /* Max width for larger screens */
            margin: 0 auto; /* Center the input wrapper */
            position: relative;
        }

        .input-field {
            flex: 1;
            min-height: 60px; /* Start with a decent height */
            max-height: 150px; /* Max height before scrolling */
            padding: 20px 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 2px solid var(--glass-border);
            border-radius: 25px; /* Rounded corners */
            resize: none; /* Disable manual resize */
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-primary);
            line-height: 1.5;
            transition: all 0.3s ease;
            overflow-y: auto; /* Add scroll for overflow */
        }

        .input-field::placeholder {
            color: var(--text-tertiary);
        }

        .input-field:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.8);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
            background: rgba(255,255,255,0.08);
        }

        .send-button {
            width: 60px;
            height: 60px;
            border-radius: 50%; /* Circular button */
            border: none;
            background: var(--primary-gradient);
            color: white;
            font-size: 1.3rem; /* Icon size */
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden; /* For hover effect */
            flex-shrink: 0; /* Prevent button from shrinking */
        }

        .send-button::before { /* Ripple effect */
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .send-button:hover::before {
            width: 100%;
            height: 100%;
        }

        .send-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.5);
        }

        .send-button:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* Loading Animation */
        .typing-indicator {
            display: flex;
            gap: 8px;
            padding: 20px; /* Add some padding */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        .typing-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-gradient); /* Use primary gradient */
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes typing {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Special Effects */
        .particle-trail {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: 50%;
            pointer-events: none;
            animation: particle-fade 1s ease-out forwards;
        }

        @keyframes particle-fade {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--glass-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-gradient);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 300px;
            }
            
            .agents-grid {
                grid-template-columns: 1fr; /* Stack agents on smaller screens */
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed; /* For mobile overlay behavior */
                left: -350px; /* Hidden by default */
                top: 0;
                height: 100vh;
                z-index: 100;
                transition: left 0.3s ease;
            }
            
            .sidebar.open {
                left: 0; /* Show sidebar */
            }
            
            .main-content {
                flex-direction: column; /* Stack sidebar and chat area */
            }
            .activity-text.error {
                color: #ff6b6b; /* Red for error status */
            }
            .header {
                padding: 15px 20px; /* Smaller padding on mobile */
            }
            
            .logo-text h1 {
                font-size: 1.5rem; /* Smaller logo text */
            }
            
            .messages-container {
                padding: 20px; /* Smaller padding */
            }
            
            .input-area {
                padding: 20px; /* Smaller padding */
            }
            
            .user-message .message-content {
                margin-left: 0; /* Adjust for mobile layout */
            }
        }

        /* Advanced Micro-interactions */
        .interactive-element {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .interactive-element:hover {
            transform: translateY(-2px);
        }

        .interactive-element:active {
            transform: translateY(0);
        }

        /* Glassmorphism Enhancement */
        .glass-surface {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        /* Neural Network Background Effect */
        .neural-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Behind all content */
            opacity: 0.1; /* Subtle effect */
        }

        .neural-node {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: 50%;
            animation: neural-pulse 4s infinite ease-in-out;
        }

        @keyframes neural-pulse {
            0%, 100% { 
                opacity: 0.3;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.5);
            }

        }


        /* Add these styles to your CSS */

/* Error Message Container */
.error-message {
    margin: 20px 0; /* Spacing around error message */
    padding: 0; /* Reset padding */
    background: transparent; /* No background for the main container */
    border: none; /* No border for the main container */
    animation: errorSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); /* Slide-in animation */
}

@keyframes errorSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.error-content {
    background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(255, 59, 59, 0.05) 100%); /* Subtle red gradient */
    backdrop-filter: blur(20px); /* Glassmorphism effect */
    border: 2px solid rgba(255, 107, 107, 0.3); /* Soft red border */
    border-radius: 20px; /* Rounded corners */
    padding: 25px;
    position: relative;
    overflow: hidden; /* For pseudo-elements */
    box-shadow: 0 12px 40px rgba(255, 107, 107, 0.2); /* Soft shadow */
}

.error-content::before { /* Top accent line */
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #ff6b6b, #ff5252, #ff1744); /* Stronger red gradient */
    border-radius: 20px 20px 0 0; /* Match top corners */
}

.error-content::after { /* Pulsing background effect */
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(255, 107, 107, 0.1) 0%, transparent 70%);
    animation: errorPulse 3s infinite ease-in-out;
}

@keyframes errorPulse {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.1); }
}

.error-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.error-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%); /* Red gradient for icon */
    border-radius: 16px; /* Rounded icon */
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px; /* Icon size */
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4); /* Icon shadow */
    position: relative;
    overflow: hidden; /* For shine effect */
}

.error-icon::before { /* Shine effect on icon */
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
    transform: rotate(-45deg);
    animation: errorShine 2s infinite;
}

@keyframes errorShine {
    0% { transform: translateX(-100%) translateY(-100%) rotate(-45deg); }
    50% { transform: translateX(100%) translateY(100%) rotate(-45deg); }
    100% { transform: translateX(-100%) translateY(-100%) rotate(-45deg); }
}

.error-title {
    color: #ffffff; /* White title */
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
}

.error-subtitle {
    color: rgba(255, 255, 255, 0.8); /* Lighter subtitle */
    font-size: 0.85rem;
    font-weight: 500;
    margin: 0;
}

.error-details {
    background: rgba(255, 255, 255, 0.1); /* Slightly lighter background for details */
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 15px;
    margin: 15px 0;
    backdrop-filter: blur(10px);
    font-family: 'JetBrains Mono', monospace; /* Monospace for error details */
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
    line-height: 1.5;
    word-break: break-word; /* Prevent overflow */
}

.error-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    flex-wrap: wrap; /* Wrap buttons on small screens */
}

.retry-button, .dismiss-button {
    padding: 12px 20px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 8px; /* Space between icon and text */
    position: relative;
    overflow: hidden; /* For hover effects */
}

.retry-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Primary gradient for retry */
    color: white;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.retry-button::before { /* Shine effect on retry button */
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: all 0.5s ease;
}

.retry-button:hover::before {
    left: 100%;
}

.retry-button:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
}

.dismiss-button {
    background: rgba(255, 255, 255, 0.1); /* Subtle background for dismiss */
    color: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
}

.dismiss-button:hover {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    transform: translateY(-2px);
}

.error-timestamp {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 500;
}

/* Responsive adjustments for error message */
@media (max-width: 768px) {
    .error-actions {
        flex-direction: column; /* Stack buttons vertically */
    }
    
    .retry-button, .dismiss-button {
        width: 100%; /* Full width buttons */
        justify-content: center; /* Center button content */
    }
}

@keyframes errorSlideOut {
    from {
        opacity: 1;
        transform: translateY(0) scale(1);
        max-height: 200px; /* Adjust based on typical error message height */
        margin: 20px 0;
    }
    to {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
        max-height: 0;
        margin: 0;
    }
}

.features-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8); /* Darker overlay */
    backdrop-filter: blur(20px); /* Stronger blur */
    z-index: 1000; /* Ensure it's on top */
    display: none; /* Hidden by default */
    opacity: 0; /* Start transparent */
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Smoother transition */
    align-items: center; /* Vertically center panel */
    justify-content: center; /* Horizontally center panel */
}

.features-overlay.active {
    display: flex; /* Use flex to center content */
    opacity: 1; /* Fade in */
}

/* Feature Panels */
.feature-panel {
    position: absolute; /* Positioned within the overlay */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.95); /* Initial state for entry animation */
    width: 90%;
    max-width: 1200px;
    max-height: 85vh; /* Max height relative to viewport */
    background: var(--glass-bg);
    backdrop-filter: blur(30px); /* Even stronger blur for panel */
    border: 2px solid var(--glass-border);
    border-radius: 24px; /* Consistent rounding */
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6); /* Pronounced shadow */
    overflow: hidden; /* Clip content */
    opacity: 0; /* Start transparent */
    pointer-events: none; /* Not interactive when hidden */
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.feature-panel.active {
    transform: translate(-50%, -50%) scale(1); /* Animate to full size */
    opacity: 1; /* Fade in */
    pointer-events: auto; /* Make interactive */
}


.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 30px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); /* Subtle gradient */
    border-bottom: 1px solid var(--glass-border);
    position: relative; /* For pseudo-element */
}

.panel-header::before { /* Top accent line for panel */
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-gradient);
}

.panel-title {
    display: flex;
    align-items: center;
    gap: 15px;
}

.panel-icon {
    width: 50px;
    height: 50px;
    background: var(--primary-gradient);
    border-radius: 15px; /* Slightly different rounding for variety */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px; /* Icon size */
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); /* Icon shadow */
}

.panel-title h3 {
    color: var(--text-primary);
    font-size: 1.4rem;
    font-weight: 700;
    margin: 0;
}

.panel-title p {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin: 0;
    font-weight: 500;
}

.panel-close {
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-secondary);
    border-radius: 12px;
    cursor: pointer;
    font-size: 18px; /* Close icon size */
    transition: all 0.3s ease;
    backdrop-filter: blur(10px); /* Blur behind close button */
}

.panel-close:hover {
    background: rgba(255, 107, 107, 0.2); /* Reddish hover for close */
    color: #ff6b6b;
    transform: scale(1.1) rotate(90deg); /* Add rotation effect */
}

.panel-content {
    padding: 30px;
    overflow-y: auto; /* Enable scrolling for content */
    max-height: calc(85vh - 120px); /* Adjust based on header height */
}

/* Statistics Panel Styles */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    position: relative;
    overflow: hidden; /* For pseudo-element */
    transition: all 0.3s ease;
}

.stat-card::before { /* Top accent line for stat card */
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    transition: all 0.3s ease;
}

.stat-card.primary::before { background: var(--primary-gradient); }
.stat-card.secondary::before { background: var(--secondary-gradient); }
.stat-card.accent::before { background: var(--accent-gradient); }
.stat-card.warning::before { background: linear-gradient(135deg, #ffd93d 0%, #ff9500 100%); } /* Warning color */

.stat-card:hover {
    transform: translateY(-5px) scale(1.02); /* Enhanced hover effect */
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
}

.stat-icon {
    width: 60px;
    height: 60px;
    background: var(--primary-gradient); /* Default icon background */
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    flex-shrink: 0; /* Prevent icon from shrinking */
}
/* Specific icon background colors for variety */
.stat-card.secondary .stat-icon { background: var(--secondary-gradient); }
.stat-card.accent .stat-icon { background: var(--accent-gradient); }
.stat-card.warning .stat-icon { background: linear-gradient(135deg, #ffd93d 0%, #ff9500 100%); }


.stat-info {
    flex: 1; /* Allow info to take remaining space */
}

.stat-value {
    font-size: 2.2rem;
    font-weight: 800;
    color: var(--text-primary);
    line-height: 1;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 600;
}

.stat-trend {
    padding: 6px 12px;
    border-radius: 20px; /* Pill shape */
    font-size: 0.8rem;
    font-weight: 600;
    margin-left: auto; /* Push trend to the right */
}

.stat-trend.up {
    background: rgba(0, 255, 136, 0.2); /* Green for upward trend */
    color: #00ff88;
}
.stat-trend.down { /* Added down trend style */
    background: rgba(255, 107, 107, 0.2); /* Red for downward trend */
    color: #ff6b6b;
}
.stat-trend.neutral {
    background: rgba(255, 255, 255, 0.1); /* Neutral color */
    color: var(--text-tertiary);
}

/* Visualization Styles */
.stats-visualization {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Two column layout for viz */
    gap: 30px;
    margin-top: 30px;
}

.viz-section h4 {
    color: var(--text-primary);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--glass-border); /* Separator for title */
    padding-bottom: 10px;
}

.status-rings {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px; /* Fixed height for rings */
    position: relative;
}
.ring-center-info { /* Style for text inside rings */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: var(--text-primary);
    z-index: 10;
}
.ring-total {
    font-size: 1.8rem;
    font-weight: 700;
}
.ring-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.status-ring {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 8px solid transparent; /* Base for ring segments */
    position: absolute;
    animation: ringRotate 10s linear infinite;
    box-shadow: 0 0 15px rgba(0,0,0,0.3); /* Add shadow to rings */
}

.status-ring.completed {
    border-color: #00ff88; /* Green */
    border-top-color: transparent; /* Create gap in ring */
}

.status-ring.in_progress {
    width: 100px; height: 100px; /* Smaller inner ring */
    border-color: #667eea; /* Blue */
    border-right-color: transparent;
    animation-delay: -2s; /* Offset animation */
}

.status-ring.failed {
    width: 80px; height: 80px; /* Smallest inner ring */
    border-color: #ff6b6b; /* Red */
    border-bottom-color: transparent;
    animation-delay: -4s;
}

.status-ring.pending {
    width: 100px; height: 100px; /* Smaller inner ring */
    border-color: #fee140; /* Yellow */
    border-right-color: transparent;
    animation-delay: -2s; /* Offset animation */
}

.status-ring.needs_verification {
    width: 100px; height: 100px; /* Smaller inner ring */
    border-color: #4facfe; /* Light blue */
    border-right-color: transparent;
    animation-delay: -2s; /* Offset animation */
}
@keyframes ringRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.agent-matrix {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Responsive agent cells */
    gap: 15px;
}

.agent-cell {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
}

.agent-cell:hover {
    background: rgba(102, 126, 234, 0.1); /* Hover effect */
    transform: scale(1.05) translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.agent-cell-icon {
    font-size: 24px;
    margin-bottom: 8px;
    /* Use specific colors for icons if desired */
}

.agent-cell-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.agent-cell-count {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

/* Task Panel Styles */
.task-overview {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    backdrop-filter: blur(15px);
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.task-id-badge {
    padding: 8px 16px;
    background: var(--primary-gradient);
    color: white;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
    font-family: 'JetBrains Mono', monospace; /* Monospace for ID */
}

.task-status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
    /* Dynamic background/color based on status in JS */
}
.task-status-indicator.status-processing {
    background: rgba(102, 126, 234, 0.1);
    border: 1px solid rgba(102, 126, 234, 0.3);
    color: #8c9eff;
}
.task-status-indicator.status-processing .status-dot { background: #667eea; }

.task-status-indicator.status-completed {
    background: rgba(0, 255, 136, 0.1);
    border: 1px solid rgba(0, 255, 136, 0.3);
    color: #00ff88;
}
.task-status-indicator.status-completed .status-dot { background: #00ff88; }

.task-status-indicator.status-failed {
    background: rgba(255, 107, 107, 0.1);
    border: 1px solid rgba(255, 107, 107, 0.3);
    color: #ff6b6b;
}
.task-status-indicator.status-failed .status-dot { background: #ff6b6b; }


.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    /* background set by specific status class */
    animation: pulse 2s infinite;
}

.task-query {
    background: rgba(255, 255, 255, 0.05); /* Darker background for query */
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    color: var(--text-primary);
    font-size: 1.1rem;
    line-height: 1.6;
}

.task-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive meta items */
    gap: 15px;
}

.meta-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
}

.meta-label {
    color: var(--text-secondary);
    font-weight: 500;
}

.meta-value {
    color: var(--text-primary);
    font-weight: 600;
    font-family: 'JetBrains Mono', monospace;
}

/* Timeline Styles */
.task-timeline {
    position: relative;
    padding-left: 10px; /* Space for the main line */
}
.task-timeline::before { /* Main vertical timeline line */
    content: '';
    position: absolute;
    left: 32px; /* Aligned with center of marker */
    top: 10px;
    bottom: 10px;
    width: 3px;
    background: linear-gradient(180deg, var(--primary-gradient) 0%, var(--secondary-gradient) 100%);
    border-radius: 2px;
    opacity: 0.5;
}

.timeline-step {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
    position: relative;
    /* animation: fadeInUp 0.5s ease-out; */ /* Animation for steps */
}

/* Removed ::before from timeline-step as main line is on task-timeline */

.timeline-marker {
    width: 45px;
    height: 45px;
    background: var(--primary-gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    z-index: 1; /* Above the main line */
    flex-shrink: 0;
    border: 3px solid var(--dark-gradient); /* Make marker pop */
}

.timeline-content {
    flex: 1;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
}

.timeline-timestamp {
    color: var(--text-tertiary);
    font-size: 0.8rem;
    margin-bottom: 10px;
    font-family: 'JetBrains Mono', monospace;
}

.timeline-data {
    color: var(--text-primary);
    line-height: 1.6;
}
.timeline-data strong {
    color: var(--secondary-gradient-text, #a8b2ff); /* Use a variable or a specific color */
    font-weight: 600;
}

/* ReAct Trace Styles */
.trace-overview {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 25px;
    backdrop-filter: blur(15px);
}
.trace-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
}
.trace-stat {
    display: flex;
    flex-direction: column;
}
.trace-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 5px;
}
.trace-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    font-family: 'JetBrains Mono', monospace;
}

.reasoning-flow {
    margin-top: 25px;
}

.reasoning-step {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    margin-bottom: 20px;
    overflow: hidden; /* For header background */
    backdrop-filter: blur(15px);
    transition: all 0.3s ease;
    animation: fadeInUp 0.6s ease-out forwards; /* Apply animation */
    opacity: 0; /* Start hidden for animation */
}
.reasoning-step:nth-child(odd) { animation-delay: 0.1s; }
.reasoning-step:nth-child(even) { animation-delay: 0.2s; }


.reasoning-step:hover {
    transform: translateX(5px) translateY(-3px); /* Subtle lift and shift */
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    border-color: rgba(102,126,234,0.5); /* Highlight border on hover */
}

.step-header {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    padding: 15px 25px;
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.step-number {
    background: var(--primary-gradient);
    color: white;
    padding: 6px 12px;
    border-radius: 15px;
    font-weight: 600;
    font-size: 0.9rem;
}

.step-type {
    padding: 4px 12px;
    background: rgba(250, 112, 154, 0.2); /* Accent color for type */
    color: #fa709a;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.step-content {
    padding: 20px 25px;
}

.step-section {
    margin-bottom: 15px;
}

.step-section:last-child {
    margin-bottom: 0;
}

.step-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.step-text {
    color: var(--text-primary);
    line-height: 1.6;
    background: rgba(255, 255, 255, 0.05); /* Darker background for text block */
    padding: 15px;
    border-radius: 10px;
    border-left: 4px solid var(--primary-gradient); /* Accent border */
    font-family: 'JetBrains Mono', monospace; /* Monospace for code-like text */
    white-space: pre-wrap; /* Preserve formatting */
    word-break: break-word;
}

.final-result {
    margin-top: 30px;
    padding: 25px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    backdrop-filter: blur(15px);
}
.final-result h4 {
    color: var(--text-primary);
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 15px;
    border-bottom: 1px solid var(--glass-border);
    padding-bottom: 10px;
}
.final-result .result-text {
    color: var(--text-primary);
    line-height: 1.7;
    font-size: 1rem;
}

/* Floating Action Buttons */
.floating-actions {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 999; /* Above chat, below overlay */
}

.fab-group {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: flex-end;
}

.fab {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px 20px;
    border: none;
    border-radius: 25px; /* Pill shape */
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden; /* For hover effect */
}

.fab::before { /* Shine effect on FAB */
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: all 0.6s ease;
}

.fab:hover::before {
    left: 100%;
}

.fab.primary {
    background: var(--primary-gradient);
    color: white;
}

.fab.secondary {
    background: var(--secondary-gradient);
    color: white;
}

.fab.accent {
    background: var(--accent-gradient);
    color: white;
}

.fab:hover {
    transform: translateY(-3px) scale(1.05) translateX(-5px); /* More dynamic hover */
    box-shadow: 0 15px 45px rgba(0, 0, 0, 0.4);
}

.fab-icon {
    font-size: 20px;
}

.fab-label {
    font-weight: 600;
    white-space: nowrap; /* Prevent label wrapping */
}

/* Responsive Design for Panels and FABs */
@media (max-width: 1024px) {
    .stats-visualization {
        grid-template-columns: 1fr; /* Stack viz sections */
    }
    
    .agent-matrix {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Adjust agent matrix */
    }
}

@media (max-width: 768px) {
    .feature-panel {
        width: 95%; /* Wider on mobile */
        max-height: 90vh; /* Taller on mobile */
    }
    
    .stats-grid {
        grid-template-columns: 1fr; /* Stack stat cards */
    }
    
    .task-meta {
        grid-template-columns: 1fr; /* Stack task meta */
    }
    
    .floating-actions { /* Center FABs on mobile */
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        right: auto;
    }
    .fab-group {
        flex-direction: row; /* Horizontal FABs on mobile */
        align-items: center;
    }
    
    .fab { /* Icon only FABs on mobile */
        width: 60px;
        height: 60px;
        border-radius: 50%;
        padding: 0;
        justify-content: center;
    }
    
    .fab-label {
        display: none; /* Hide label on mobile */
    }
}

/* Animation Enhancements */
@keyframes pulse { /* General pulse animation */
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.9); }
}

@keyframes fadeInUp { /* General fade in up animation */
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Apply fadeInUp to specific elements if needed, e.g., .stat-card, .timeline-step */
.stat-card, .timeline-step {
    /* animation: fadeInUp 0.5s ease-out forwards; */ /* Can be enabled if desired */
    /* opacity: 0; */ /* Initial state for animation */
}
/* Stagger animations for lists */
.stats-grid .stat-card:nth-child(1) { animation-delay: 0.1s; }
.stats-grid .stat-card:nth-child(2) { animation-delay: 0.2s; }
.stats-grid .stat-card:nth-child(3) { animation-delay: 0.3s; }
.stats-grid .stat-card:nth-child(4) { animation-delay: 0.4s; }

.task-timeline .timeline-step:nth-child(odd) { animation-delay: 0.15s; }
.task-timeline .timeline-step:nth-child(even) { animation-delay: 0.25s; }

/* Styling for math expressions */
.math-expression {
    font-family: 'JetBrains Mono', monospace; /* Or a dedicated math font */
    background: rgba(255, 255, 255, 0.1);
    padding: 2px 5px;
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 0.9em; /* Slightly smaller */
}
sup, sub {
    line-height: 0; /* Prevent affecting line height */
}

/* Styling for physics and chemistry specific terms */
.physics-constant, .chemistry-element {
    color: #a8b2ff; /* A light blue/purple, adjust as needed */
    font-weight: 500;
    background: rgba(102, 126, 234, 0.1);
    padding: 1px 4px;
    border-radius: 3px;
}

/* Tool Output Styling */
.tool-output {
    margin-top: 15px;
    padding: 15px;
    background: rgba(0,0,0, 0.2); /* Darker background for contrast */
    border-radius: 8px;
    border-left: 3px solid var(--accent-gradient);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--text-secondary);
    white-space: pre-wrap; /* Preserve formatting */
    word-break: break-all; /* Break long strings */
}
.tool-output strong {
    color: var(--accent-gradient-text, #f093fb); /* Use a variable or specific color */
    display: block;
    margin-bottom: 8px;
}

/* Task Selector Styling (inside panel content) */
.task-selector, .trace-selector {
    padding: 20px;
    text-align: center;
}
.task-selector h3, .trace-selector h3 {
    color: var(--text-primary);
    margin-bottom: 15px;
}
.task-selector p, .trace-selector p {
    color: var(--text-secondary);
    margin-bottom: 20px;
}
.task-input-group, .trace-input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
}
.task-input-group input, .trace-input-group input {
    flex-grow: 1;
    padding: 12px 18px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    color: var(--text-primary);
    font-family: 'Inter', sans-serif;
    font-size: 0.95rem;
}
.task-input-group input::placeholder, .trace-input-group input::placeholder {
    color: var(--text-tertiary);
}
.task-input-group button, .trace-input-group button {
    padding: 12px 25px;
    background: var(--primary-gradient);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}
.task-input-group button:hover, .trace-input-group button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}
.recent-tasks h4 {
    color: var(--text-primary);
    margin-bottom: 15px;
    text-align: left;
}
.recent-tasks p { /* For loading message */
    color: var(--text-tertiary);
    text-align: left;
}
    
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="background-animation">
        <div class="floating-shapes">
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
    </div>

    <!-- Neural Network Background -->
    <div class="neural-bg" id="neuralBg"></div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo-section">
                <div class="logo-icon">
                    🧠
                </div>
                <div class="logo-text">
                    <h1>NeuroTutor AI</h1>
                    <p>Advanced Multi-Agent Learning System</p>
                </div>
            </div>
            
            <div class="header-controls">
                <div class="header-buttons">
                    <button class="header-btn analytics-btn" onclick="openStatsPanel()" title="Neural Analytics">
                        <div class="btn-icon">📊</div>
                        <div class="btn-label">Analytics</div>
                    </button>
                    
                    <button class="header-btn tasks-btn" onclick="openTaskExplorer()" title="Task Explorer">
                        <div class="btn-icon">🎯</div>
                        <div class="btn-label">Tasks</div>
                    </button>
                    
                    <button class="header-btn trace-btn" onclick="openTraceViewer()" title="ReAct Trace">
                        <div class="btn-icon">🔍</div>
                        <div class="btn-label">Trace</div>
                    </button>
                </div>
                <div class="neural-activity">
                    <div class="activity-dots">
                        <div class="activity-dot"></div>
                        <div class="activity-dot"></div>
                        <div class="activity-dot"></div>
                    </div>
                    <span class="activity-text">Live</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-section">
                    <h3 class="section-title">
                        ✨ New Session
                    </h3>
                    <button class="new-chat-btn interactive-element" onclick="startNewChat()">
                        🚀 Launch New Learning Session
                    </button>
                </div>

                <div class="sidebar-section">
                    <h3 class="section-title">
                        🤖 AI Specialists
                    </h3>
                    <div class="agents-grid">
                        <div class="agent-card interactive-element active" data-agent="tutor">
                            <div class="agent-icon">🎓</div>
                            <div class="agent-name">Master Tutor</div>
                            <div class="agent-specialty">Learning Coordinator</div>
                        </div>
                        <div class="agent-card interactive-element" data-agent="math">
                            <div class="agent-icon">📊</div>
                            <div class="agent-name">Math Expert</div>
                            <div class="agent-specialty">Calculus & Algebra</div>
                        </div>
                        <div class="agent-card interactive-element" data-agent="physics">
                            <div class="agent-icon">⚡</div>
                            <div class="agent-name">Physics Guru</div>
                            <div class="agent-specialty">Quantum & Classical</div>
                        </div>
                        <div class="agent-card interactive-element" data-agent="chemistry">
                            <div class="agent-icon">🧪</div>
                            <div class="agent-name">Chem Wizard</div>
                            <div class="agent-specialty">Organic & Inorganic</div>
                        </div>
                        <div class="agent-card interactive-element" data-agent="history">
                            <div class="agent-icon">📚</div>
                            <div class="agent-name">History Sage</div>
                            <div class="agent-specialty">World Chronicles</div>
                        </div>
                        <div class="agent-card interactive-element" data-agent="biology">
                            <div class="agent-icon">🧬</div>
                            <div class="agent-name">Bio Specialist</div>
                            <div class="agent-specialty">Life Sciences</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="section-title">
                        💬 Chat History
                    </h3>
                    <div id="historyList" class="history-list">
                        <!-- Chat history items will be populated here -->
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="chat-area">
                <div class="messages-container" id="messagesContainer">
                    <!-- Welcome Message -->
                    <div class="message">
                        <div class="message-wrapper">
                            <div class="message-avatar assistant-avatar">🧠</div>
                            <div class="message-content">
                                <div class="message-header">
                                    <strong>NeuroTutor AI</strong>
                                    <div class="agent-badge">Master Intelligence</div>
                                    <div class="message-time">Just now</div>
                                </div>
                                <div class="message-text">
                                    Welcome to the most advanced AI learning experience ever created! 🚀
                                    <br><br>
                                    I'm your personal learning companion, backed by cutting-edge neural networks and specialized AI agents:
                                    <br><br>
                                    🎯 <strong>Adaptive Learning</strong> - Personalized to your pace and style<br>
                                    🧮 <strong>Mathematics</strong> - From basic algebra to advanced calculus<br>
                                    ⚛️ <strong>Physics</strong> - Classical mechanics to quantum phenomena<br>
                                    🔬 <strong>Chemistry</strong> - Molecular structures to complex reactions<br>
                                    🌍 <strong>History</strong> - Ancient civilizations to modern events<br>
                                    🧬 <strong>Biology</strong> - Cell biology to evolutionary science
                                    <br><br>
                                    Ask me anything, and I'll instantly connect you with the perfect specialist! ✨
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="features-overlay" id="featuresOverlay">
                    <!-- Statistics Dashboard -->
                    <div class="feature-panel stats-panel" id="statsPanel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <div class="panel-icon">📊</div>
                                <div>
                                    <h3>Neural Analytics</h3>
                                    <p>Real-time System Intelligence</p>
                                </div>
                            </div>
                            <button class="panel-close" onclick="closePanel('statsPanel')">✕</button>
                        </div>
                        
                        <div class="panel-content">
                            <div class="stats-grid">
                                <div class="stat-card primary">
                                    <div class="stat-icon">🧠</div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="totalSessions">--</div>
                                        <div class="stat-label">Active Sessions</div>
                                    </div>
                                    <div class="stat-trend up">+12%</div>
                                </div>
                                
                                <div class="stat-card secondary">
                                    <div class="stat-icon">💬</div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="totalMessages">--</div>
                                        <div class="stat-label">Messages Processed</div>
                                    </div>
                                    <div class="stat-trend up">+8%</div>
                                </div>
                                
                                <div class="stat-card accent">
                                    <div class="stat-icon">⚡</div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="totalTasks">--</div>
                                        <div class="stat-label">Tasks Completed</div>
                                    </div>
                                    <div class="stat-trend up">+15%</div>
                                </div>
                                
                                <div class="stat-card warning">
                                    <div class="stat-icon">🔄</div>
                                    <div class="stat-info">
                                        <div class="stat-value" id="maxSteps">--</div>
                                        <div class="stat-label">Max ReAct Steps</div>
                                    </div>
                                    <div class="stat-trend neutral">--</div>
                                </div>
                            </div>
                            
                            <div class="stats-visualization">
                                <div class="viz-section">
                                    <h4>Task Status Distribution</h4>
                                    <div class="status-rings" id="statusRings">
                                        <!-- Dynamic rings will be generated here -->
                                    </div>
                                </div>
                                
                                <div class="viz-section">
                                    <h4>Agent Performance Matrix</h4>
                                    <div class="agent-matrix" id="agentMatrix">
                                        <!-- Dynamic agent visualization -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Task Details Panel -->
                    <div class="feature-panel task-panel" id="taskPanel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <div class="panel-icon">🎯</div>
                                <div>
                                    <h3>Task Deep Dive</h3>
                                    <p>Comprehensive Task Analysis</p>
                                </div>
                            </div>
                            <button class="panel-close" onclick="closePanel('taskPanel')">✕</button>
                        </div>
                        
                        <div class="panel-content">
                            <div class="task-overview">
                                <div class="task-header">
                                    <div class="task-id-badge" id="taskIdBadge">TASK-001</div>
                                    <div class="task-status-indicator" id="taskStatusIndicator">
                                        <div class="status-dot"></div>
                                        <span>Processing</span>
                                    </div>
                                </div>
                                
                                <div class="task-query" id="taskQuery">
                                    Loading task details...
                                </div>
                                
                                <div class="task-meta">
                                    <div class="meta-item">
                                        <span class="meta-label">Agent:</span>
                                        <span class="meta-value" id="taskAgent">--</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">Steps:</span>
                                        <span class="meta-value" id="taskSteps">--</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">Verifications:</span>
                                        <span class="meta-value" id="taskVerifications">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="task-timeline" id="taskTimeline">
                                <!-- Dynamic timeline will be populated here -->
                            </div>
                        </div>
                    </div>
                
                    <!-- ReAct Trace Viewer -->
                    <div class="feature-panel trace-panel" id="tracePanel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <div class="panel-icon">🔍</div>
                                <div>
                                    <h3>ReAct Reasoning Trace</h3>
                                    <p>Step-by-step AI Thinking Process</p>
                                </div>
                            </div>
                            <button class="panel-close" onclick="closePanel('tracePanel')">✕</button>
                        </div>
                        
                        <div class="panel-content">
                            <div class="trace-overview">
                                <div class="trace-stats">
                                    <div class="trace-stat">
                                        <span class="trace-label">Total Steps:</span>
                                        <span class="trace-value" id="traceTotalSteps">--</span>
                                    </div>
                                    <div class="trace-stat">
                                        <span class="trace-label">Agent:</span>
                                        <span class="trace-value" id="traceAgent">--</span>
                                    </div>
                                    <div class="trace-stat">
                                        <span class="trace-label">Status:</span>
                                        <span class="trace-value" id="traceStatus">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="reasoning-flow" id="reasoningFlow">
                                <!-- Dynamic reasoning steps will be populated here -->
                            </div>
                            
                            <div class="final-result" id="finalResult">
                                <!-- Final result will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Floating Action Buttons -->
                <!-- <div class="floating-actions">
                    <div class="fab-group">
                        <button class="fab primary" onclick="openStatsPanel()" title="Neural Analytics">
                            <div class="fab-icon">📊</div>
                            <div class="fab-label">Analytics</div>
                        </button>
                        
                        <button class="fab secondary" onclick="openTaskExplorer()" title="Task Explorer">
                            <div class="fab-icon">🎯</div>
                            <div class="fab-label">Tasks</div>
                        </button>
                        
                        <button class="fab accent" onclick="openTraceViewer()" title="ReAct Trace">
                            <div class="fab-icon">🔍</div>
                            <div class="fab-label">Trace</div>
                        </button>
                    </div>
                </div> -->

                <!-- Typing Indicator (Hidden by default) -->
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            class="input-field" 
                            placeholder="Ask me anything about math, science, history... I'm here to help you learn! 🚀"
                            rows="1"
                        ></textarea>
                        <button id="sendButton" class="send-button interactive-element" onclick="sendMessage()">
                            ➤
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Application state
        let currentSessionId = generateSessionId();
        let isLoading = false;
        let messageHistory = [];
        let connectionStatus = true;
        let allSessions = []; // Add this line after line 534 (after let connectionStatus = true;)

        class AdvancedFeaturesManager {
    constructor() {
        this.baseURL = window.location.origin;
        this.currentTask = null;
        this.statistics = null;
        this.updateInterval = null;
        this.isInitialized = false;
        
        this.init();
    }

    async init() {
        try {
            console.log('🚀 Initializing Advanced Features Manager...');
            await this.loadStatistics();
            this.setupEventListeners();
            this.startAutoRefresh();
            this.isInitialized = true;
            console.log('✅ Advanced Features Manager initialized successfully');
        } catch (error) {
            console.error('❌ Failed to initialize Advanced Features Manager:', error);
        }
    }

    // API Methods
    async apiRequest(endpoint, options = {}) {
        try {
            const response = await fetch(`${this.baseURL}${endpoint}`, {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'API request unsuccessful');
            }

            return data;
        } catch (error) {
            console.error(`API Error (${endpoint}):`, error);
            throw error;
        }
    }

    async loadStatistics() {
        try {
            console.log('📊 Loading statistics...');
            const response = await this.apiRequest('/api/statistics');
            this.statistics = response.statistics;
            console.log('📊 Statistics loaded:', this.statistics);
            return this.statistics;
        } catch (error) {
            console.error('Failed to load statistics:', error);
            // Return fallback data
            this.statistics = {
                total_sessions: 0,
                total_messages: 0,
                total_tasks: 0,
                task_status_counts: {},
                agent_usage: {},
                max_react_steps: 10
            };
            return this.statistics;
        }
    }

    async loadTaskDetails(taskId) {
        try {
            console.log(`🎯 Loading task details for ${taskId}...`);
            const response = await this.apiRequest(`/api/tasks/${taskId}`);
            this.currentTask = response.task;
            console.log('🎯 Task details loaded:', this.currentTask);
            return this.currentTask;
        } catch (error) {
            console.error(`Failed to load task ${taskId}:`, error);
            throw error;
        }
    }

    async loadReActTrace(taskId) {
        try {
            console.log(`🔍 Loading ReAct trace for ${taskId}...`);
            const response = await this.apiRequest(`/api/react-trace/${taskId}`);
            const trace = response.trace;
            console.log('🔍 ReAct trace loaded:', trace);
            return trace;
        } catch (error) {
            console.error(`Failed to load ReAct trace for ${taskId}:`, error);
            throw error;
        }
    }

    // Panel Management
    openStatsPanel() {
    console.log('📊 Opening statistics panel...');
    const panel = document.getElementById('statsPanel');
    if (!panel) {
        console.error('❌ statsPanel element not found in DOM');
        return;
    }
    this.showOverlay();
    this.showPanel('statsPanel');
    this.renderStatistics();
}

async openTaskExplorer(taskId = null) {
    console.log('🎯 Opening task explorer...');
    const panel = document.getElementById('taskPanel');
    if (!panel) {
        console.error('❌ taskPanel element not found in DOM');
        return;
    }
    this.showOverlay();
    this.showPanel('taskPanel');
    
    if (taskId) {
        await this.loadAndDisplayTask(taskId);
    } else {
        await this.renderTaskSelector();
    }
}
async openTraceViewer(taskId = null) {
    console.log('🔍 Opening trace viewer...');
    const panel = document.getElementById('tracePanel');
    if (!panel) {
        console.error('❌ tracePanel element not found in DOM');
        return;
    }
    this.showOverlay();
    this.showPanel('tracePanel');
    
    if (taskId) {
        await this.loadAndDisplayTrace(taskId);
    } else {
        await this.renderTraceSelector();
    }
}

    showOverlay() {
        const overlay = document.getElementById('featuresOverlay');
        if (overlay) {
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    hideOverlay() {
        const overlay = document.getElementById('featuresOverlay');
        if (overlay) {
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            
            // Hide all panels
            document.querySelectorAll('.feature-panel').forEach(panel => {
                panel.classList.remove('active');
            });
        }
    }

    showPanel(panelId) {
    // Hide all panels first
    document.querySelectorAll('.feature-panel').forEach(p => {
                    if (p.id !== panelId) {
                        p.classList.remove('active');
                    }
                });
                // Then show the target panel
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.classList.add('active');
                } else {
                    console.error(`Panel with ID '${panelId}' not found`);
                }
}


    

closePanel(panelId) {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.classList.remove('active');
                }
                
                // Check if any other panel is active, if not, hide overlay
                const anyActivePanel = document.querySelector('.feature-panel.active');
                if (!anyActivePanel) {
                     setTimeout(() => { // Delay to allow panel fade-out
                        this.hideOverlay();
                    }, 300); // Match transition duration slightly less
                }
            }

    // Statistics rendering
    renderStatistics() {
        if (!this.statistics) return;

        const stats = this.statistics;
        
        // Update stat cards
        this.updateElement('totalSessions', stats.total_sessions);
        this.updateElement('totalMessages', stats.total_messages);
        this.updateElement('totalTasks', stats.total_tasks);
        this.updateElement('maxSteps', stats.max_react_steps);

        // Render status rings
        this.renderStatusRings(stats.task_status_counts);
        
        // Render agent matrix
        this.renderAgentMatrix(stats.agent_usage);
    }

    renderStatusRings(statusCounts) {
        const container = document.getElementById('statusRings');
                if (!container) return;

                const total = Object.values(statusCounts).reduce((sum, count) => sum + (count || 0), 0);
                this.updateElement('vizTotalTasks', total); // Update total in center
                
                container.querySelectorAll('.status-ring').forEach(r => r.remove()); // Clear old rings first, but keep center info
                
                const statuses = [
                    { key: 'completed', color: '#00ff88', className: 'completed', sizeFactor: 1 }, // Largest
                    { key: 'failed', color: '#ff6b6b', className: 'failed', sizeFactor: 0.6 }, // Smallest
                    { key: 'in_progress', color: '#fee140', className: 'in_progress', sizeFactor: 0.8 },
                    { key: 'pending', color: '#fee140', className: 'pending', sizeFactor: 0.5 },
                    { key: 'needs_verification', color: '#4facfe', className: 'needs_verification', sizeFactor: 0.4 }
                ];
                const baseSize = 120; // px

                statuses.forEach((status, index) => {
                    const count = statusCounts[status.key] || 0;
                    // const percentage = total > 0 ? (count / total) * 100 : 0; // Not directly used for ring segments here
                    
                    const ring = document.createElement('div');
                    ring.className = `status-ring ${status.className}`;
                    ring.style.width = `${baseSize * status.sizeFactor}px`;
                    ring.style.height = `${baseSize * status.sizeFactor}px`;
                    // ring.style.borderColor = status.color; // Full ring color
                    // To make segments, you'd typically use SVG or multiple divs/clip-paths
                    // For simplicity, the CSS already defines border colors and gaps
                    ring.style.animationDelay = `${index * -1.5}s`; // Stagger animation
                    
                    container.appendChild(ring);
                });
    }

    renderAgentMatrix(agentUsage) {
        const container = document.getElementById('agentMatrix');
                if (!container) return;

                const agents = [
                    { key: 'Math Agent', icon: '📊', name: 'Math' },
                    { key: 'Physics Agent', icon: '⚡', name: 'Physics' },
                    { key: 'Chemistry Agent', icon: '🧪', name: 'Chemistry' },
                    { key: 'History Agent', icon: '📚', name: 'History' },
                    { key: 'Biology Agent', icon: '🧬', name: 'Biology' },
                    { key: 'Tutor Agent', icon: '🎓', name: 'Tutor' }
                ];

                container.innerHTML = ''; // Clear previous cells

                agents.forEach(agent => {
                    const count = agentUsage[agent.key] || 0;
                    
                    const cell = document.createElement('div');
                    cell.className = 'agent-cell';
                    cell.innerHTML = `
                        <div class="agent-cell-icon">${agent.icon}</div>
                        <div class="agent-cell-name">${agent.name}</div>
                        <div class="agent-cell-count">${count} tasks</div>
                    `;
                    container.appendChild(cell);
                });
    }

    // Task Management
    async loadAndDisplayTask(taskId) {
        try {
            const task = await this.loadTaskDetails(taskId);
            this.renderTaskDetails(task);
        } catch (error) {
            this.showErrorMessage('taskPanel', `Failed to load task details for ${taskId}.`);
        }
    }

    async renderTaskSelector() {
        // If we don't have a specific task, show a selector or recent tasks
        const taskContent = document.querySelector('#taskPanel .panel-content');
                if (taskContent) {
                    taskContent.innerHTML = `
                        <div class="task-selector">
                            <h3>Select a Task to Analyze</h3>
                            <p>Enter a task ID or select from recent (mock) tasks:</p>
                            <div class="task-input-group">
                                <input type="text" id="taskIdInput" placeholder="Enter Task ID (e.g., TASK-MOCK-123)" />
                                <button onclick="featuresManager.loadTaskFromInput()">Load Task</button>
                            </div>
                            <div class="recent-tasks" id="recentTasks">
                                <h4>Recent Mock Tasks</h4>
                                <button onclick="featuresManager.loadAndDisplayTask('TASK-MOCK-001')">View TASK-MOCK-001</button>
                                <button onclick="featuresManager.loadAndDisplayTask('TASK-MOCK-002')">View TASK-MOCK-002</button>
                            </div>
                        </div>
                    `;
                }
    }

    async loadTaskFromInput() {
        const input = document.getElementById('taskIdInput');
        const taskId = input?.value?.trim();
        
        if (!taskId) {
            alert('Please enter a task ID');
            return;
        }
        
        await this.loadAndDisplayTask(taskId);
    }

    renderTaskDetails(task) {
        const panelContent = document.querySelector('#taskPanel .panel-content');
                if (!panelContent || !task) {
                    this.showErrorMessage('taskPanel', 'Task data is unavailable.');
                    return;
                }

                panelContent.innerHTML = `
                    <div class="task-overview">
                        <div class="task-header">
                            <div class="task-id-badge">${task.id || 'UNKNOWN'}</div>
                            <div class="task-status-indicator status-${task.status || 'unknown'}">
                                <div class="status-dot"></div>
                                <span>${(task.status || 'unknown').replace(/^\w/, c => c.toUpperCase())}</span>
                            </div>
                        </div>
                        <div class="task-query">${task.query || 'No query available.'}</div>
                        <div class="task-meta">
                            <div class="meta-item">
                                <span class="meta-label">Agent:</span>
                                <span class="meta-value">${task.assigned_agent || '--'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Steps:</span>
                                <span class="meta-value">${task.steps?.length || 0}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Verifications:</span>
                                <span class="meta-value">${task.verification_attempts || 0}</span>
                            </div>
                             <div class="meta-item">
                                <span class="meta-label">Created:</span>
                                <span class="meta-value">${task.created_at ? new Date(task.created_at).toLocaleString() : '--'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="task-timeline">
                        ${(task.steps || []).map((step, index) => `
                            <div class="timeline-step">
                                <div class="timeline-marker">${index + 1}</div>
                                <div class="timeline-content">
                                    <div class="timeline-timestamp">${step.timestamp ? new Date(step.timestamp).toLocaleTimeString() : `Step ${index + 1}`}</div>
                                    <div class="timeline-data">
                                        ${step.thought ? `<strong>Thought:</strong> ${this.escapeHtml(step.thought)}<br>` : ''}
                                        ${step.action ? `<strong>Action:</strong> ${this.escapeHtml(step.action)}<br>` : ''}
                                        ${step.action_input ? `<strong>Input:</strong> <pre>${this.escapeHtml(JSON.stringify(step.action_input, null, 2))}</pre>` : ''}
                                        ${step.observation ? `<strong>Observation:</strong> ${this.escapeHtml(step.observation)}` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
    }

    // renderTaskTimeline(task) {
    //     const timeline = document.getElementById('taskTimeline');
    //     if (!timeline || !task.steps) return;

    //     timeline.innerHTML = '';

    //     task.steps.forEach((step, index) => {
    //         const timelineStep = document.createElement('div');
    //         timelineStep.className = 'timeline-step';
            
    //         const timestamp = step.timestamp ? 
    //             new Date(step.timestamp).toLocaleTimeString() : 
    //             `Step ${index + 1}`;
            
    //         timelineStep.innerHTML = `
    //             <div class="timeline-marker">${index + 1}</div>
    //             <div class="timeline-content">
    //                 <div class="timeline-timestamp">${timestamp}</div>
    //                 <div class="timeline-data">
    //                     <strong>Thought:</strong> ${step.thought || 'No thought recorded'}<br>
    //                     <strong>Action:</strong> ${step.action || 'No action recorded'}<br>
    //                     ${step.observation ? `<strong>Observation:</strong> ${step.observation}` : ''}
    //                 </div>
    //             </div>
    //         `;
            
    //         timeline.appendChild(timelineStep);
    //     });
    // }

    // ReAct Trace Management
    async loadAndDisplayTrace(taskId) {
        try {
            const trace = await this.loadReActTrace(taskId);
            this.renderReActTrace(trace);
        } catch (error) {
            this.showErrorMessage('tracePanel', `Failed to load ReAct trace for ${taskId}.`);
        }
    }

    async renderTraceSelector() {
        const traceContent = document.querySelector('#tracePanel .panel-content');
                if (traceContent) {
                    traceContent.innerHTML = `
                        <div class="trace-selector">
                            <h3>Select a Task for ReAct Trace</h3>
                            <p>Enter a task ID to view its reasoning trace (mock data will be used):</p>
                            <div class="trace-input-group">
                                <input type="text" id="traceTaskIdInput" placeholder="Enter Task ID (e.g., TASK-MOCK-123)" />
                                <button onclick="featuresManager.loadTraceFromInput()">Load Trace</button>
                            </div>
                             <div class="recent-tasks">
                                <h4>Recent Mock Traces</h4>
                                <button onclick="featuresManager.loadAndDisplayTrace('TASK-MOCK-001')">View Trace for TASK-MOCK-001</button>
                                <button onclick="featuresManager.loadAndDisplayTrace('TASK-MOCK-002')">View Trace for TASK-MOCK-002</button>
                            </div>
                        </div>
                    `;
                }
    }

    async loadTraceFromInput() {
        const input = document.getElementById('traceTaskIdInput');
        const taskId = input?.value?.trim();
        
        if (!taskId) {
            alert('Please enter a task ID');
            return;
        }
        
        await this.loadAndDisplayTrace(taskId);
    }

    renderReActTrace(trace) {
        // Update trace overview
        const panelContent = document.querySelector('#tracePanel .panel-content');
                 if (!panelContent || !trace) {
                    this.showErrorMessage('tracePanel', 'Trace data is unavailable.');
                    return;
                 }

                 panelContent.innerHTML = `
                    <div class="trace-overview">
                        <div class="trace-stats">
                            <div class="trace-stat">
                                <span class="trace-label">Task ID:</span>
                                <span class="trace-value">${trace.task_id || 'N/A'}</span>
                            </div>
                            <div class="trace-stat">
                                <span class="trace-label">Agent:</span>
                                <span class="trace-value">${trace.agent || 'Unknown'}</span>
                            </div>
                            <div class="trace-stat">
                                <span class="trace-label">Status:</span>
                                <span class="trace-value">${trace.status || 'Unknown'}</span>
                            </div>
                            <div class="trace-stat">
                                <span class="trace-label">Total Steps:</span>
                                <span class="trace-value">${trace.total_steps || 0}</span>
                            </div>
                        </div>
                    </div>
                    <div class="reasoning-flow">
                        ${(trace.steps || []).map((step, index) => `
                            <div class="reasoning-step">
                                <div class="step-header">
                                    <div class="step-number">Step ${step.step_number || index + 1}</div>
                                    <div class="step-type">${this.escapeHtml(this.getStepType(step))}</div>
                                </div>
                                <div class="step-content">
                                    ${step.thought ? `<div class="step-section"><div class="step-label">Thought</div><div class="step-text">${this.escapeHtml(step.thought)}</div></div>` : ''}
                                    ${step.action ? `<div class="step-section"><div class="step-label">Action</div><div class="step-text">${this.escapeHtml(step.action)}</div></div>` : ''}
                                    ${step.action_input ? `<div class="step-section"><div class="step-label">Action Input</div><div class="step-text">${this.escapeHtml(this.formatActionInput(step.action_input))}</div></div>` : ''}
                                    ${step.observation ? `<div class="step-section"><div class="step-label">Observation</div><div class="step-text">${this.escapeHtml(step.observation)}</div></div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${trace.final_result ? `
                        <div class="final-result">
                            <h4>Final Result</h4>
                            <div class="result-text">${this.escapeHtml(trace.final_result)}</div>
                        </div>
                    ` : ''}
                 `;
    }

    // renderReasoningFlow(steps) {
    //     const flowContainer = document.getElementById('reasoningFlow');
    //     if (!flowContainer) return;

    //     flowContainer.innerHTML = '';

    //     steps.forEach((step, index) => {
    //         const reasoningStep = document.createElement('div');
    //         reasoningStep.className = 'reasoning-step';
    //         reasoningStep.style.animationDelay = `${index * 0.1}s`;
            
    //         reasoningStep.innerHTML = `
    //             <div class="step-header">
    //                 <div class="step-number">Step ${step.step_number || index + 1}</div>
    //                 <div class="step-type">${this.getStepType(step)}</div>
    //             </div>
    //             <div class="step-content">
    //                 ${step.thought ? `
    //                     <div class="step-section">
    //                         <div class="step-label">Thought</div>
    //                         <div class="step-text">${step.thought}</div>
    //                     </div>
    //                 ` : ''}
    //                 ${step.action ? `
    //                     <div class="step-section">
    //                         <div class="step-label">Action</div>
    //                         <div class="step-text">${step.action}</div>
    //                     </div>
    //                 ` : ''}
    //                 ${step.action_input ? `
    //                     <div class="step-section">
    //                         <div class="step-label">Action Input</div>
    //                         <div class="step-text">${this.formatActionInput(step.action_input)}</div>
    //                     </div>
    //                 ` : ''}
    //                 ${step.observation ? `
    //                     <div class="step-section">
    //                         <div class="step-label">Observation</div>
    //                         <div class="step-text">${step.observation}</div>
    //                     </div>
    //                 ` : ''}
    //             </div>
    //         `;
            
    //         flowContainer.appendChild(reasoningStep);
    //     });
    // }

    // renderFinalResult(finalResult) {
    //     const resultContainer = document.getElementById('finalResult');
    //     if (!resultContainer) return;

    //     if (finalResult) {
    //         resultContainer.innerHTML = `
    //             <div class="final-result-content">
    //                 <h4>Final Result</h4>
    //                 <div class="result-text">${finalResult}</div>
    //             </div>
    //         `;
    //         resultContainer.style.display = 'block';
    //     } else {
    //         resultContainer.style.display = 'none';
    //     }
    // }

    // Utility Methods
    escapeHtml(unsafe) {
                if (unsafe === null || typeof unsafe === 'undefined') return '';
                return String(unsafe)
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }

            // Utility Methods
            getStepType(step) {
                if (step.action) {
                    return step.action.split('_')[0].toUpperCase() || 'ACTION';
                }
                return 'THOUGHT';
            }

            formatActionInput(input) {
                if (typeof input === 'object') {
                    return JSON.stringify(input, null, 2);
                }
                return String(input);
            }

            updateElement(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value !== null && typeof value !== 'undefined' ? value : '--';
                }
            }

            showErrorMessage(panelId, message) {
                const panel = document.getElementById(panelId);
                if (panel) {
                    const content = panel.querySelector('.panel-content');
                    if (content) {
                        // Simplified error display within the panel
                        content.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                                <p>⚠️ ${this.escapeHtml(message)}</p>
                                <button onclick="featuresManager.closePanel('${panelId}')" style="margin-top:10px; padding: 8px 15px; background: var(--primary-gradient); color:white; border:none; border-radius:8px; cursor:pointer;">Close</button>
                            </div>`;
                    }
                }
            }

    // Auto-refresh functionality
    startAutoRefresh() {
                this.stopAutoRefresh(); // Clear existing interval if any
                this.updateInterval = setInterval(async () => {
                    try {
                        await this.loadStatistics();
                        const statsPanel = document.getElementById('statsPanel');
                        if (statsPanel && statsPanel.classList.contains('active')) {
                            this.renderStatistics();
                        }
                    } catch (error) {
                        console.error('Auto-refresh failed:', error);
                    }
                }, 30000); // Refresh every 30 seconds
            }

            stopAutoRefresh() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            }

            setupEventListeners() {
                const overlay = document.getElementById('featuresOverlay');
                if (overlay) {
                    overlay.addEventListener('click', (e) => {
                        if (e.target.id === 'featuresOverlay') { // Click on overlay background
                            this.hideOverlay();
                        }
                    });
                }
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('featuresOverlay')?.classList.contains('active')) {
                        this.hideOverlay();
                    }
                });
            }

    // Public API for external integration
    // async refreshStatistics() {
    //     return await this.loadStatistics();
    // }

    // async viewTask(taskId) {
    //     await this.openTaskExplorer(taskId);
    // }

    // async viewTrace(taskId) {
    //     await this.openTraceViewer(taskId);
    // }

    destroy() {
        this.stopAutoRefresh();
        console.log('AdvancedFeaturesManager destroyed.');
        // Clean up any other resources
    }
}

// Global functions for HTML onclick handlers
function openStatsPanel() {
    if (window.featuresManager) {
        window.featuresManager.openStatsPanel();
    }
}

function openTaskExplorer(taskId = null) {
    if (window.featuresManager) {
        window.featuresManager.openTaskExplorer(taskId);
    }
}

function openTraceViewer(taskId = null) {
    if (window.featuresManager) {
        window.featuresManager.openTraceViewer(taskId);
    }
}

function closePanel(panelId) {
    if (window.featuresManager) {
        window.featuresManager.closePanel(panelId);
    }
}

// // Initialize when DOM is ready
// document.addEventListener('DOMContentLoaded', function() {
//     
// });

// // Export for module systems
// if (typeof module !== 'undefined' && module.exports) {
//     module.exports = AdvancedFeaturesManager;
// }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 DOM loaded, initializing Advanced Features Manager...');
            if (!window.featuresManager) { 
                 window.featuresManager = new AdvancedFeaturesManager();
                 window.featuresManager.init(); 
            }
            setupEventListeners();
            loadChatHistory();
            checkServerHealth();
            setInterval(checkServerHealth, 30000); // Check every 30 seconds
            
            // window.featuresManager = new AdvancedFeaturesManager();
        });

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send message on Enter (but not Shift+Enter)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Add click event listener for send button
            sendButton.addEventListener('click', function() {
                sendMessage();
            });

            // Handle paste events for better UX
            messageInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                }, 0);
            });
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || isLoading) return;

            // Add user message to UI
            addMessageToUI('user', message);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Update UI state
            setLoading(true);
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: currentSessionId
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    addMessageToUI('assistant', data.response, {
                        agent: data.delegated_to || data.agent,
                        subject: data.subject,
                        toolsUsed: data.tools_used,
                        toolOutput: data.tool_output,
                        task_id: data.task_id // Add this line
                    });
                    
                    // Update active agent indicator
                    updateActiveAgent(data.subject);
                    
                    // Update connection status
                    updateConnectionStatus(true);
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('Error sending message:', error);
                addErrorMessage(error.message, message);
                updateConnectionStatus(false);
            } finally {
                setLoading(false);
            }
        }

        function addMessageToUI(role, content, metadata = {}) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            const timestamp = new Date().toLocaleTimeString();
            
            let avatarContent = role === 'user' ? 'You' : 'AI';
            let avatarClass = role === 'user' ? 'user-avatar' : 'assistant-avatar';
            
            let agentBadge = '';
            if (role === 'assistant' && metadata.agent) {
                agentBadge = `<span class="agent-badge">${metadata.agent}</span>`;
            }
            let taskIdDisplay = ''; // Add this block
            if (role === 'assistant' && metadata.task_id) {
                taskIdDisplay = `<span class="task-id-display" title="View Task Details" onclick="openTaskExplorer('${metadata.task_id}')">Task ID: ${metadata.task_id}</span>`;
            }
            // Process content for special formatting
            const processor = new AdvancedTextProcessor();
            let processedContent = processor.processMessageContent(content, metadata);
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar ${avatarClass}">${avatarContent}</div>
                    <div class="message-info">
                        <strong>${role === 'user' ? 'You' : metadata.agent || 'AI Tutor'}</strong>
                        ${agentBadge}
                        <span>${timestamp}</span>
                        ${taskIdDisplay} 
                    </div>
                </div>
                <div class="message-content">
                    ${processedContent}
                    ${metadata.toolOutput ? formatToolOutput(metadata.toolOutput) : ''}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            // Store in message history
            messageHistory.push({
                role,
                content,
                timestamp,
                metadata
            });
            
            // Update chat history in sidebar
            updateChatHistory();
        }

        class AdvancedTextProcessor {
    constructor() {
        this.patterns = new Map();
        this.initializePatterns();
    }

    initializePatterns() {
        // Mathematical expressions with seamless styling
        this.patterns.set('fractions', {
            regex: /(\d+)\/(\d+)/g,
            replace: '<span style="font-family: inherit; color: inherit; background: transparent;">$1/$2</span>'
        });

        this.patterns.set('exponents', {
            regex: /([a-zA-Z0-9]+)\^([0-9]+)/g,
            replace: '$1<sup style="font-size: 0.75em; vertical-align: super; color: inherit;">$2</sup>'
        });

        this.patterns.set('subscripts', {
            regex: /([A-Z][a-z]?)(\d+)/g,
            replace: '$1<sub style="font-size: 0.75em; vertical-align: sub; color: inherit;">$2</sub>'
        });

        this.patterns.set('square_roots', {
            regex: /√(\d+)/g,
            replace: '<span style="font-family: inherit; color: inherit;">√$1</span>'
        });

        // Text formatting without boxes
        this.patterns.set('bold', {
            regex: /\*\*(.*?)\*\*/g,
            replace: '<strong style="font-weight: 600; color: inherit; background: transparent;">$1</strong>'
        });

        this.patterns.set('italic', {
            regex: /\*(.*?)\*/g,
            replace: '<em style="font-style: italic; color: inherit; background: transparent;">$1</em>'
        });

        this.patterns.set('inline_code', {
            regex: /`(.*?)`/g,
            replace: '<code style="font-family: \'Courier New\', monospace; color: #d63384; background: transparent; border: none; padding: 0;">$1</code>'
        });

        // Headers with clean styling
        this.patterns.set('h2', {
            regex: /^#\s+(.+)$/gm,
            replace: '<h2 style="font-size: 1.4rem; font-weight: 600; color: #2563eb; margin: 20px 0 15px 0; background: transparent; border: none;">$1</h2>'
        });

        this.patterns.set('h3', {
            regex: /^##\s+(.+)$/gm,
            replace: '<h3 style="font-size: 1.2rem; font-weight: 600; color: #2563eb; margin: 15px 0 10px 0; background: transparent; border: none;">$1</h3>'
        });

        // Steps with clean numbering
        this.patterns.set('steps', {
            regex: /Step\s+(\d+):/g,
            replace: '<span style="font-weight: 600; color: #2563eb; background: transparent; margin-right: 8px;">Step $1:</span>'
        });
    }

    formatMathExpressions(content) {
        // Apply mathematical formatting patterns
        const mathPatterns = ['fractions', 'exponents', 'subscripts', 'square_roots'];
        
        return mathPatterns.reduce((text, patternName) => {
            const pattern = this.patterns.get(patternName);
            return text.replace(pattern.regex, pattern.replace);
        }, content);
    }

    processLists(content) {
        // Numbered lists without boxes
        content = content.replace(/^(\d+)\.\s+(.+)$/gm, 
            '<div style="margin: 8px 0; color: inherit; background: transparent; border: none;"><span style="font-weight: 600; color: #2563eb; margin-right: 8px;">$1.</span>$2</div>');
        
        // Bullet points without boxes
        content = content.replace(/^[\-\*]\s+(.+)$/gm, 
            '<div style="margin: 6px 0; color: inherit; background: transparent; border: none;"><span style="color: #2563eb; margin-right: 8px;">•</span>$1</div>');
        
        return content;
    }

    processCodeBlocks(content) {
        // Code blocks with minimal styling
        return content.replace(/```([\s\S]*?)```/g, 
            '<pre style="font-family: \'Courier New\', monospace; color: #495057; background: transparent; border: 1px solid #dee2e6; border-radius: 4px; padding: 12px; margin: 10px 0; overflow-x: auto;"><code>$1</code></pre>');
    }

    highlightSubjectTerms(content, subject) {
        if (!subject) return content;

        const subjectData = {
            physics: {
                constants: ['speed of light', 'planck constant', 'gravitational constant', 
                          'electron mass', 'proton mass', 'avogadro number', 'boltzmann constant'],
                units: ['m/s', 'kg', 'm', 's', 'N', 'J', 'W', 'Hz', 'Pa', 'V', 'A', 'C'],
                style: 'color: #7c3aed; font-weight: 500; background: transparent;'
            },
            chemistry: {
                elements: ['hydrogen', 'helium', 'carbon', 'oxygen', 'nitrogen', 
                          'sodium', 'chlorine', 'iron', 'gold', 'silver', 'calcium', 
                          'potassium', 'magnesium', 'aluminum', 'phosphorus'],
                style: 'color: #dc2626; font-weight: 500; background: transparent;'
            }
        };

        const data = subjectData[subject.toLowerCase()];
        if (!data) return content;

        // Highlight subject-specific terms
        if (data.constants) {
            data.constants.forEach(term => {
                const regex = new RegExp(`\\b${term}\\b`, 'gi');
                content = content.replace(regex, 
                    `<span style="${data.style}">${term}</span>`);
            });
        }

        if (data.elements) {
            data.elements.forEach(element => {
                const regex = new RegExp(`\\b${element}\\b`, 'gi');
                content = content.replace(regex, 
                    `<span style="${data.style}">${element}</span>`);
            });
        }

        if (data.units) {
            data.units.forEach(unit => {
                const escapedUnit = unit.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`\\b\\d+(?:\\.\\d+)?\\s*${escapedUnit}\\b`, 'g');
                content = content.replace(regex, 
                    `<span style="${data.style}">$&</span>`);
            });
        }

        return content;
    }

    processMessageContent(content, metadata = {}) {
        if (!content || typeof content !== 'string') {
            return '';
        }

        let processedContent = content;

        // Apply text formatting patterns
        const textPatterns = ['bold', 'italic', 'inline_code', 'h2', 'h3', 'steps'];
        processedContent = textPatterns.reduce((text, patternName) => {
            const pattern = this.patterns.get(patternName);
            return text.replace(pattern.regex, pattern.replace);
        }, processedContent);

        // Process different content types
        processedContent = this.processCodeBlocks(processedContent);
        processedContent = this.processLists(processedContent);
        processedContent = this.formatMathExpressions(processedContent);
        
        // Subject-specific highlighting
        if (metadata.subject) {
            processedContent = this.highlightSubjectTerms(processedContent, metadata.subject);
        }

        // Convert line breaks (do this last)
        processedContent = processedContent.replace(/\n/g, '<br>');

        return processedContent;
    }
}

        function formatToolOutput(toolOutput) {
            if (!toolOutput || typeof toolOutput !== 'object') return '';
            
            let formatted = '<div class="tool-output">';
            formatted += '<strong>🔧 Tool Output:</strong><br>';
            
            if (toolOutput.success && toolOutput.result !== undefined) {
                if (toolOutput.formatted) {
                    formatted += toolOutput.formatted;
                } else if (typeof toolOutput.result === 'object') {
                    formatted += JSON.stringify(toolOutput.result, null, 2);
                } else {
                    formatted += toolOutput.result;
                }
            } else if (toolOutput.error) {
                formatted += `Error: ${toolOutput.error}`;
            } else {
                formatted += JSON.stringify(toolOutput, null, 2);
            }
            
            formatted += '</div>';
            return formatted;
        }

        function addErrorMessage(errorText, originalMessage) {
    const messagesContainer = document.getElementById('messagesContainer');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    
    const timestamp = new Date().toLocaleTimeString();
    const errorId = 'error_' + Date.now();
    
    // Determine error type and customize message
    let errorTitle = 'Connection Failed';
    let errorSubtitle = 'Unable to reach the AI service';
    let errorIcon = '⚠️';
    
    if (errorText.includes('Server error: 5')) {
        errorTitle = 'Server Overloaded';
        errorSubtitle = 'The AI is currently processing too many requests';
        errorIcon = '🔥';
    } else if (errorText.includes('timeout') || errorText.includes('Network')) {
        errorTitle = 'Network Timeout';
        errorSubtitle = 'Your connection seems unstable';
        errorIcon = '🌐';
    } else if (errorText.includes('rate limit')) {
        errorTitle = 'Rate Limited';
        errorSubtitle = 'Please wait a moment before trying again';
        errorIcon = '⏱️';
    }
    
    errorDiv.innerHTML = `
        <div class="error-content">
            <div class="error-timestamp">${timestamp}</div>
            
            <div class="error-header">
                <div class="error-icon">${errorIcon}</div>
                <div>
                    <h4 class="error-title">${errorTitle}</h4>
                    <p class="error-subtitle">${errorSubtitle}</p>
                </div>
            </div>
            
            <div class="error-details">
                ${errorText}
            </div>
            
            <div class="error-actions">
                <button class="retry-button interactive-element" 
                        onclick="retryMessage('${originalMessage.replace(/'/g, "\\'")}'); dismissError('${errorId}')">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M8 3V0L4 4L8 8V5C11.31 5 14 7.69 14 11C14 14.31 11.31 17 8 17C4.69 17 2 14.31 2 11H0C0 15.42 3.58 19 8 19C12.42 19 16 15.42 16 11C16 6.58 12.42 3 8 3Z" fill="currentColor"/>
                    </svg>
                    Retry Message
                </button>
                <button class="dismiss-button interactive-element" 
                        onclick="dismissError('${errorId}')">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Dismiss
                </button>
            </div>
        </div>
    `;
    
    errorDiv.id = errorId;
    messagesContainer.appendChild(errorDiv);
    scrollToBottom();
    
    // Auto-dismiss after 10 seconds
    setTimeout(() => {
        const errorElement = document.getElementById(errorId);
        if (errorElement) {
            dismissError(errorId);
        }
    }, 10000);
}

// Add this new function for dismissing errors
        function dismissError(errorId) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.style.animation = 'errorSlideOut 0.4s ease-in-out forwards';
                setTimeout(() => {
                    if (errorElement.parentNode) {
                        errorElement.parentNode.removeChild(errorElement);
                    }
                }, 400);
            }
        }
        async function retryMessage(message) {
    if (isLoading) return;
    
    // Set loading state
    setLoading(true);
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                session_id: currentSessionId
            })
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
            addMessageToUI('assistant', data.response, {
                agent: data.delegated_to || data.agent,
                subject: data.subject,
                toolsUsed: data.tools_used,
                toolOutput: data.tool_output,
                task_id: data.task_id // Add this line
            });
            
            updateActiveAgent(data.subject);
            updateConnectionStatus(true);
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
        
    } catch (error) {
        console.error('Error retrying message:', error);
        addErrorMessage(error.message, message);
        updateConnectionStatus(false);
    } finally {
        setLoading(false);
    }
}

        function setLoading(loading) {
            isLoading = loading;
            const sendButton = document.getElementById('sendButton');
            const messagesContainer = document.getElementById('messagesContainer');
            
            sendButton.disabled = loading;
            
            // Remove existing loading indicator
            const existingLoader = document.querySelector('.typing-indicator');
            if (existingLoader) {
                existingLoader.remove();
            }
            
            if (loading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'typing-indicator';
                loadingDiv.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                messagesContainer.appendChild(loadingDiv);
                scrollToBottom();
            }
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function updateActiveAgent(subject) {
            // Remove active class from all agents
            document.querySelectorAll('.agent-card').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to current agent
            const agentMap = {
                'math': 'math',
                'physics': 'physics', 
                'chemistry': 'chemistry',
                'history': 'history'
            };
            
            const agentElement = document.querySelector(`[data-agent="${agentMap[subject] || 'tutor'}"]`);
            if (agentElement) {
                agentElement.classList.add('active');
            }
        }

        function updateConnectionStatus(connected) {
    connectionStatus = connected;
    const activityText = document.querySelector('.activity-text');
    const activityDots = document.querySelector('.activity-dots');
    
    if (activityText && activityDots) {
        if (connected) {
            activityText.textContent = 'Live';
            activityDots.style.opacity = '1';
        } else {
            activityText.textContent = 'Not Live';
            activityDots.style.opacity = '0.3';
        }
    }
}

        async function checkServerHealth() {
            try {
                const response = await fetch('/health');
                if (response.ok) {
                    updateConnectionStatus(true);
                } else {
                    updateConnectionStatus(false);
                }
            } catch (error) {
                updateConnectionStatus(false);
            }
        }

        function startNewChat() {
    // Save current session to history before starting new one (only if it's not already saved)
    if (messageHistory.length > 0) {
        const existingIndex = allSessions.findIndex(s => s.id === currentSessionId);
        if (existingIndex >= 0) {
            // Update existing session instead of adding duplicate
            allSessions[existingIndex].messages = [...messageHistory];
            allSessions[existingIndex].preview = getSessionPreview();
        } else {
            // Only add if it doesn't already exist
            allSessions.push({
                id: currentSessionId,
                preview: getSessionPreview(),
                messages: [...messageHistory],
                timestamp: new Date()
            });
        }
    }
    
    // Start new session
    currentSessionId = generateSessionId();
    messageHistory = [];
    
    // Clear messages container
    const messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.innerHTML = `
        <div class="message">
            <div class="message-header">
                <div class="message-avatar assistant-avatar">AI</div>
                <div class="message-info">
                    <strong>AI Tutor</strong>
                    <span class="agent-badge">Main Agent</span>
                </div>
            </div>
            <div class="message-content">
                Welcome to a new chat session! I'm ready to help you with math, physics, chemistry, or history. What would you like to learn about today?
            </div>
        </div>
    `;
    
    // Reset active agent
    document.querySelectorAll('.agent-card').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector('[data-agent="tutor"]').classList.add('active');
    
    updateChatHistory();
}
function updateChatHistory() {
    const historyList = document.getElementById('historyList');
    
    // Create a copy of all sessions
    const sessionsToShow = [...allSessions];
    
    // Only add current session if it's not already in allSessions and has messages
    const currentExists = allSessions.some(s => s.id === currentSessionId);
    if (!currentExists && messageHistory.length > 0) {
        sessionsToShow.push({
            id: currentSessionId,
            preview: getSessionPreview(),
            active: false, // Don't mark as active here, we'll do it below
            timestamp: new Date()
        });
    }
    
    // Sort by timestamp (newest first)
    sessionsToShow.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    historyList.innerHTML = '';
    sessionsToShow.forEach(session => {
        const historyItem = document.createElement('div');
        // Mark the current session as active
        historyItem.className = `history-item ${session.id === currentSessionId ? 'active' : ''}`;
        historyItem.innerHTML = session.preview;
        historyItem.onclick = () => loadSession(session.id);
        historyList.appendChild(historyItem);
    });
}

        function getSessionPreview() {
            if (messageHistory.length === 0) {
                return 'New Chat Session';
            }
            
            const firstUserMessage = messageHistory.find(msg => msg.role === 'user');
            if (firstUserMessage) {
                return firstUserMessage.content.substring(0, 50) + (firstUserMessage.content.length > 50 ? '...' : '');
            }
            
            return 'Chat Session';
        }

        function loadSession(sessionId) {
    if (sessionId === currentSessionId) return; // Already loaded
    
    // Save current session before switching (only if it's not already in allSessions)
    if (messageHistory.length > 0) {
        const existingIndex = allSessions.findIndex(s => s.id === currentSessionId);
        if (existingIndex >= 0) {
            // Update existing session
            allSessions[existingIndex].messages = [...messageHistory];
            allSessions[existingIndex].preview = getSessionPreview();
        } else {
            // Add new session only if it doesn't exist
            allSessions.push({
                id: currentSessionId,
                preview: getSessionPreview(),
                messages: [...messageHistory],
                timestamp: new Date()
            });
        }
    }
    
    // Load the selected session
    const sessionToLoad = allSessions.find(s => s.id === sessionId);
    if (sessionToLoad) {
        currentSessionId = sessionId;
        messageHistory = [...sessionToLoad.messages];
        
        // Clear and reload messages
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = '';
        
        // Add welcome message
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'message';
        welcomeDiv.innerHTML = `
            <div class="message-header">
                <div class="message-avatar assistant-avatar">AI</div>
                <div class="message-info">
                    <strong>AI Tutor</strong>
                    <span class="agent-badge">Main Agent</span>
                </div>
            </div>
            <div class="message-content">
                Welcome back to this chat session!
            </div>
        `;
        messagesContainer.appendChild(welcomeDiv);
        
        // Reload all messages from history
        messageHistory.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.role}-message`;
            
            let avatarContent = msg.role === 'user' ? 'You' : 'AI';
            let avatarClass = msg.role === 'user' ? 'user-avatar' : 'assistant-avatar';
            
            let agentBadge = '';
            let taskIdDisplayFromHistory = ''; // Add this
            if (msg.role === 'assistant' && msg.metadata) {
                if (msg.metadata.agent) {
                    agentBadge = `<span class="agent-badge">${msg.metadata.agent}</span>`;
                }
                if (msg.metadata.task_id) { // Add this check
                    taskIdDisplayFromHistory = `<span class="task-id-display" title="View Task Details" onclick="openTaskExplorer('${msg.metadata.task_id}')">Task ID: ${msg.metadata.task_id}</span>`;
                }
            }
            const processor = new AdvancedTextProcessor();
            let processedContent = processor.processMessageContent(msg.content, msg.metadata || {});
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar ${avatarClass}">${avatarContent}</div>
                    <div class="message-info">
                        <strong>${msg.role === 'user' ? 'You' : (msg.metadata && msg.metadata.agent) || 'AI Tutor'}</strong>
                        ${agentBadge}
                        ${taskIdDisplayFromHistory} 
                        <span>${msg.timestamp}</span>
                    </div>
                </div>
                <div class="message-content">
                    ${processedContent}
                    ${msg.metadata && msg.metadata.toolOutput ? formatToolOutput(msg.metadata.toolOutput) : ''}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        });
        
        scrollToBottom();
        updateChatHistory(); // This will now correctly show the session as active without duplicating
    }
}

        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/history/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.history.length > 0) {
                        // Load existing conversation
                        data.history.forEach(msg => {
                            if (msg.role !== 'system') {
                                let messageMetadata = msg.metadata || { agent: msg.agent, task_id: msg.task_id };
                                addMessageToUI(msg.role, msg.content, messageMetadata);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        // Initialize on load
        window.addEventListener('load', function() {
            document.querySelector('[data-agent="tutor"]').classList.add('active');
        });
    </script>
</body>
</html>
